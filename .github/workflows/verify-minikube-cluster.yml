name: ğŸ”· Verify Minikube Cluster Setup

on:
  schedule:
    # Run daily at 08:30 UTC (offset from Kind workflow)
    - cron: '30 8 * * *'
  push:
    branches: [ main, master ]
    paths:
      - 'minikube-lab/**'
      - 'demo-app/**'
      - 'k8s-lab.sh'
      - '.github/workflows/verify-minikube-cluster.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'minikube-lab/**'
      - 'demo-app/**'
      - 'k8s-lab.sh'
      - '.github/workflows/verify-minikube-cluster.yml'
  workflow_dispatch:
  workflow_call:

jobs:
  verify-minikube-setup:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ“¦ Install Minikube
      run: |
        # Install Minikube
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        rm minikube-linux-amd64
        
        # Verify installation
        minikube version

    - name: ğŸ”§ Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/kubectl
        
        # Verify installation
        kubectl version --client

    - name: ğŸš€ Set up Minikube cluster
      run: |
        echo "ğŸ”· Setting up Minikube cluster for verification..."
        cd minikube-lab
        chmod +x setup-minikube.sh
        ./setup-minikube.sh ci-test-profile

    - name: âœ… Verify cluster is running
      run: |
        echo "ğŸ” Checking cluster status..."
        minikube status -p ci-test-profile
        kubectl cluster-info
        
        echo "ğŸ“Š Checking node status..."
        kubectl get nodes -o wide
        
        echo "ğŸ§© Checking system pods..."
        kubectl get pods -A
        
        # Wait for all system pods to be ready
        echo "â³ Waiting for system pods to be ready..."
        kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=300s

    - name: ğŸ›ï¸ Verify Minikube addons
      run: |
        echo "ğŸ›ï¸ Checking enabled addons..."
        minikube addons list -p ci-test-profile
        
        echo "ğŸ“Š Verifying metrics-server..."
        kubectl get pods -n kube-system -l k8s-app=metrics-server
        
        echo "ğŸ“‹ Verifying dashboard..."
        kubectl get pods -n kubernetes-dashboard || echo "Dashboard may not be fully ready yet"

    - name: ğŸ¯ Deploy demo application
      run: |
        echo "ğŸš€ Deploying demo application..."
        cd demo-app
        chmod +x deploy-demo.sh
        ./deploy-demo.sh minikube ci-test-profile
        
        echo "â³ Waiting for demo pods to be ready..."
        kubectl wait --for=condition=Ready pods --all -n default --timeout=300s

    - name: ğŸ§ª Test demo application
      run: |
        echo "ğŸ§ª Testing demo application functionality..."
        
        # Get demo app pod
        POD_NAME=$(kubectl get pods -l app=demo-app -o jsonpath='{.items[0].metadata.name}')
        echo "Demo app pod: $POD_NAME"
        
        # Test pod is running
        kubectl get pod $POD_NAME
        
        # Test service is accessible via minikube service
        minikube service demo-app --url -p ci-test-profile &
        SERVICE_PID=$!
        sleep 10
        
        # Get the service URL
        SERVICE_URL=$(minikube service demo-app --url -p ci-test-profile)
        echo "Service URL: $SERVICE_URL"
        
        # Test HTTP response
        if curl -f $SERVICE_URL; then
            echo "âœ… Demo app is responding correctly"
        else
            echo "âŒ Demo app is not responding"
            exit 1
        fi
        
        # Clean up
        kill $SERVICE_PID || true

    - name: ğŸ—ï¸ Test advanced demos
      run: |
        echo "ğŸ—ï¸ Testing advanced demo deployments..."
        cd demo-app/advanced-demos
        chmod +x deploy-advanced-demos.sh
        
        # Test each demo individually
        echo "Testing ConfigMap/Secret demo..."
        ./deploy-advanced-demos.sh minikube ci-test-profile configmap
        kubectl wait --for=condition=Ready pods -l app=configmap-secret-demo --timeout=180s
        
        echo "Testing StatefulSet demo..."
        ./deploy-advanced-demos.sh minikube ci-test-profile stateful
        kubectl wait --for=condition=Ready pods -l app=mongodb --timeout=300s
        
        echo "Testing HPA demo..."
        ./deploy-advanced-demos.sh minikube ci-test-profile hpa
        kubectl wait --for=condition=Ready pods -l app=hpa-demo --timeout=180s

    - name: ğŸ“Š Test metrics server
      run: |
        echo "ğŸ“Š Testing metrics server functionality..."
        
        # Wait for metrics to be available
        echo "â³ Waiting for metrics to be collected..."
        sleep 30
        
        # Test node metrics
        kubectl top nodes || echo "Node metrics not yet available"
        
        # Test pod metrics
        kubectl top pods || echo "Pod metrics not yet available"

    - name: ğŸ” Final cluster verification
      run: |
        echo "ğŸ” Final verification of cluster health..."
        kubectl get all -A
        
        echo "ğŸ“Š Resource usage summary:"
        kubectl describe nodes
        
        echo "ğŸ›ï¸ Final addon status:"
        minikube addons list -p ci-test-profile

    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up resources..."
        minikube delete -p ci-test-profile || true
        docker system prune -f || true

    - name: ğŸ“Š Report Results
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Minikube cluster verification PASSED"
        else
          echo "âŒ Minikube cluster verification FAILED"
        fi
